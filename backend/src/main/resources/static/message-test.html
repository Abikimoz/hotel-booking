<!DOCTYPE html>
<html>
<head>
    <title>Message Test Client</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .input-group {
            margin-bottom: 20px;
        }
        .chat-window {
            height: 400px;
            border: 1px solid #ccc;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 20px;
        }
        .message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .sent {
            background-color: #e3f2fd;
            margin-left: 20%;
        }
        .received {
            background-color: #f5f5f5;
            margin-right: 20%;
        }
        .message-input {
            width: 70%;
            padding: 10px;
        }
        button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="input-group">
            <input type="number" id="userId" placeholder="Your User ID">
            <input type="number" id="receiverId" placeholder="Receiver User ID">
            <button onclick="loadMessages()">Load Messages</button>
        </div>
        
        <div class="chat-window" id="chatWindow"></div>
        
        <div class="input-group">
            <input type="text" id="messageInput" class="message-input" placeholder="Type your message...">
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        let stompClient = null;
        let userId = null;

        function connect() {
            userId = document.getElementById('userId').value;
            if (!userId) {
                alert('Please enter your user ID');
                return;
            }

            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            
            stompClient.connect({}, function(frame) {
                console.log('Connected: ' + frame);
                stompClient.subscribe('/user/queue/messages', function(message) {
                    const receivedMessage = JSON.parse(message.body);
                    displayMessage(receivedMessage, false);
                });
            });
        }

        function loadMessages() {
            userId = document.getElementById('userId').value;
            if (!userId) {
                alert('Please enter your user ID');
                return;
            }

            // Получаем все сообщения пользователя
            fetch(`/api/messages/${userId}`)
                .then(response => response.json())
                .then(messages => {
                    const chatWindow = document.getElementById('chatWindow');
                    chatWindow.innerHTML = '';
                    messages.forEach(message => {
                        const isSent = message.senderId === parseInt(userId);
                        displayMessage(message, isSent);
                    });
                })
                .catch(error => console.error('Error loading messages:', error));
        }

        function sendMessage() {
            const content = document.getElementById('messageInput').value;
            const receiverId = document.getElementById('receiverId').value;
            
            if (!content || !receiverId) {
                alert('Please enter message content and receiver ID');
                return;
            }

            if (!stompClient) {
                connect();
            }

            const message = {
                senderId: parseInt(userId),
                receiverId: parseInt(receiverId),
                content: content
            };

            stompClient.send("/app/sendMessage", {}, JSON.stringify(message));
            document.getElementById('messageInput').value = '';
        }

        function displayMessage(message, isSent) {
            const chatWindow = document.getElementById('chatWindow');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
            
            const time = new Date(message.createdAt).toLocaleTimeString();
            messageDiv.innerHTML = `
                <strong>${isSent ? 'You' : 'User ' + message.senderId}</strong>
                <p>${message.content}</p>
                <small>${time}</small>
            `;
            
            chatWindow.appendChild(messageDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
    </script>
</body>
</html> 